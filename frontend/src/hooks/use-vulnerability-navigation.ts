import { useCallback, useMemo, useState } from "react"
import { useAutoResetState } from "@/hooks/use-auto-reset-state"
import {
  buildCodeAnnotationsForFile,
  findVulnerabilityById,
} from "@/lib/vulnerabilities"
import type { CodeAnnotation, Vulnerability } from "@/types"

interface UseVulnerabilityNavigationOptions {
  vulnerabilities: Vulnerability[]
  selectedFile: string | null
  navigateToFile: (filePath: string) => void
  controlledVulnId?: string | null
  setControlledVulnId?: (id: string | null) => void
  controlledLine?: number | null
  setControlledLine?: (line: number | null) => void
}

export function useVulnerabilityNavigation({
  vulnerabilities,
  selectedFile,
  navigateToFile,
  controlledVulnId,
  setControlledVulnId,
  controlledLine,
  setControlledLine,
}: UseVulnerabilityNavigationOptions) {
  const [internalVulnId, setInternalVulnId] = useState<string | null>(null)
  const [internalLine, setInternalLine] = useState<number | null>(null)
  const [scrollToVulnerabilityId, setScrollToVulnerabilityId] =
    useAutoResetState<string | null>(null, 2000)

  const isVulnControlled = controlledVulnId !== undefined
  const vulnId = isVulnControlled ? controlledVulnId : internalVulnId
  const setVulnId = isVulnControlled
    ? (setControlledVulnId ?? (() => {}))
    : setInternalVulnId

  const isLineControlled = controlledLine !== undefined
  const scrollToLine = isLineControlled ? controlledLine : internalLine
  const setScrollToLine = isLineControlled
    ? (setControlledLine ?? (() => {}))
    : setInternalLine

  const selectedVulnerability = useMemo(() => {
    if (!vulnId) return null
    return findVulnerabilityById(vulnerabilities, vulnId) ?? null
  }, [vulnId, vulnerabilities])

  const setSelectedVulnerability = useCallback(
    (vuln: Vulnerability | null) => {
      setVulnId(vuln?.id ?? null)
    },
    [setVulnId],
  )

  const handleSelectVulnerability = useCallback(
    (vuln: Vulnerability) => {
      setSelectedVulnerability(vuln)
      const firstLocation = vuln.description[0]
      if (firstLocation) {
        navigateToFile(firstLocation.file)
        setScrollToLine(firstLocation.line_start)
      } else {
        setScrollToLine(null)
      }
    },
    [navigateToFile, setScrollToLine, setSelectedVulnerability],
  )

  const handleNavigateToLocation = useCallback(
    (file: string, lineStart: number) => {
      navigateToFile(file)
      setScrollToLine(lineStart)
    },
    [navigateToFile, setScrollToLine],
  )

  const handleAnnotationClick = useCallback(
    (annotationId: string) => {
      const vuln = findVulnerabilityById(vulnerabilities, annotationId)
      if (vuln) {
        setSelectedVulnerability(vuln)
        setScrollToVulnerabilityId(annotationId)
      }
    },
    [vulnerabilities, setScrollToVulnerabilityId, setSelectedVulnerability],
  )

  const clearSelection = useCallback(() => {
    setSelectedVulnerability(null)
    setScrollToLine(null)
    setScrollToVulnerabilityId(null)
  }, [setScrollToLine, setScrollToVulnerabilityId, setSelectedVulnerability])

  const codeAnnotations = useMemo<CodeAnnotation[]>(
    () => buildCodeAnnotationsForFile(selectedFile, vulnerabilities),
    [selectedFile, vulnerabilities],
  )

  return {
    selectedVulnerability,
    scrollToLine,
    scrollToVulnerabilityId,
    codeAnnotations,
    setSelectedVulnerability,
    handleSelectVulnerability,
    handleNavigateToLocation,
    handleAnnotationClick,
    clearSelection,
  }
}
