"use client"

import { Bug01Icon } from "@hugeicons/core-free-icons"
import { useMemo, useRef } from "react"
import { InlineMarkdown } from "@/components/markdown"
import { ScrollArea } from "@/components/ui/scroll-area"
import { useScrollIntoView } from "@/hooks/use-scroll-into-view"
import { cn } from "@/lib/utils"
import { sortVulnerabilitiesBySeverity } from "@/lib/vulnerabilities"
import { SEVERITY_CONFIG, type Vulnerability } from "@/types"
import { PanelHeader } from "./panel-header"

interface VulnerabilityListPanelProps {
  isCollapsed?: boolean
  onToggleCollapse?: () => void
  showCollapseToggle?: boolean
  vulnerabilities: Vulnerability[]
  selectedVulnerability: Vulnerability | null
  onSelectVulnerability: (vuln: Vulnerability) => void
  scrollToVulnerabilityId?: string | null
}

export function VulnerabilityListPanel({
  isCollapsed = false,
  onToggleCollapse,
  showCollapseToggle = true,
  vulnerabilities,
  selectedVulnerability,
  onSelectVulnerability,
  scrollToVulnerabilityId,
}: VulnerabilityListPanelProps) {
  const listRef = useRef<HTMLDivElement>(null)

  const scrollTarget = scrollToVulnerabilityId
    ? `[data-vulnerability-id="${CSS.escape(scrollToVulnerabilityId)}"]`
    : null
  useScrollIntoView(listRef, scrollTarget)
  const sortedVulnerabilities = useMemo(
    () => sortVulnerabilitiesBySeverity(vulnerabilities),
    [vulnerabilities],
  )

  return (
    <div className="flex h-full min-w-0 flex-col overflow-hidden my-1.5 lg:my-0">
      <PanelHeader
        icon={Bug01Icon}
        title="Vulnerabilities"
        count={sortedVulnerabilities.length}
        isCollapsed={isCollapsed}
        onToggleCollapse={onToggleCollapse}
        showCollapseToggle={showCollapseToggle}
      />
      {!isCollapsed && (
        <ScrollArea className="min-w-0 flex-1 mt-1.5 max-h-48 md:max-h-none">
          <div ref={listRef} className="px-2">
            {sortedVulnerabilities.length === 0 ? (
              <div className="px-2 text-xs text-muted-foreground">
                No vulnerabilities reported yet.
              </div>
            ) : (
              sortedVulnerabilities.map((vuln) => (
                <button
                  key={vuln.id}
                  type="button"
                  data-vulnerability-id={vuln.id}
                  onClick={() => onSelectVulnerability(vuln)}
                  className={cn(
                    "flex min-w-0 w-full items-start gap-2 rounded-sm px-2 py-0.5 text-left text-sm hover:bg-muted/50",
                    selectedVulnerability?.id === vuln.id &&
                      "inset-ring-1 inset-ring-border bg-muted/50",
                  )}
                >
                  <span className="shrink-0 whitespace-nowrap pt-0.5 tabular-nums text-xs text-muted-foreground">
                    {vuln.id}
                  </span>
                  <span
                    className={cn(
                      "mt-1.5 size-2 shrink-0 rounded-full",
                      SEVERITY_CONFIG[vuln.severity].bgForeground,
                    )}
                  />
                  <span className="min-w-0 text-foreground/80">
                    <InlineMarkdown>{vuln.title}</InlineMarkdown>
                  </span>
                </button>
              ))
            )}
          </div>
        </ScrollArea>
      )}
    </div>
  )
}
